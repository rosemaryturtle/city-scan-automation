---
format:
  html:
    theme: [source/custom.scss, none]
editor: source
execute:
  echo: false
  output: false
  cache: false
engine: knitr
---

::: setup

```{r}
#| include: false
#| label: prerender
source('R/setup.R')

# Run clean-tabular.R if processed folder doesn't exist (needed for OJS plots)
processed_dir <- file.path(output_dir, "tabular", "processed")
if (!dir.exists(processed_dir) || length(list.files(processed_dir)) == 0) {
  source('R/clean-tabular.R')
}

source('R/maps-web.R')
cover_image <- fuzzy_read(file.path(output_dir, "maps"), "^aoi.png$", paste)
```

```{r}
#| cache: false
# Which layers do we have plots for? Tell Observable cells
ojs_define(createdMaps = names(plots_html))
```

---
title: "`r paste(city, country, sep = ', ')`"
---

```{r}
#| label: get-text
generic_text <- read_yaml("source/generic-text.yml") %>% rapply(double_space, how = "replace") # Do I only want this for print?
city_text_file <- file.path(user_input_dir, "text-files/manual-text.md")
if (file.exists(city_text_file)) {
  city_text <- read_md(city_text_file)
  slide_texts <- merge_lists(city_text, generic_text)
} else {
  slide_texts <- generic_text
}
slide_texts <- unlist(slide_texts, recursive = F) %>%
  setNames(str_extract(names(.), "\\.(.*)$", group = T))
```

```{r}
#| cache: false
ojs_define(city = city)
ojs_define(country = country)
ojs_define(layerParams = layer_params)
ojs_define(slide_texts = slide_texts)
```

```{ojs}
//| label: ojs-plots-setup
import { setD3, setWidth, setHeightRatio, setCity, setCountry, plot_pga, plot_pgp, plot_pas, plot_pas_pyramid, plot_age, plot_dependency, plot_rwi_area, plot_uba_area, plot_ubaa, plot_ubap, plot_lc, plot_uddm, plot_pv_area, plot_pv_alt, plot_pv_d, plot_pv, plot_aq, plot_summer_area, plot_ndvi_area, plot_fe, plot_fu, plot_pu, plot_cu, plot_comb, plot_e, plot_s, plot_ls_area, plot_l_area, plot_fwi, plot_fwi_d } from "./ojs/plots.js"
// import { loadData } from "./ojs/dataloader.js" // Moved to bottom of doc -- I suppose all of this should be moved there too

function renderDiv(text, divClass) {
  if (!text) return "";
  const textMarkdown = Array.isArray(text) ? md`${text.join('\n')}` : md`${text}`;
  return html`<div class="${divClass}">${textMarkdown}</div>`;
}

function addSlideText(slide) {
  return html`
  ${renderDiv(slide.takeaways, "takeaways")}
  ${renderDiv(slide.method, "method")}
  ${renderDiv(slide.footnote, "footnote")}`
}

function fillSlide(layer, chart = null, extra_layers = [], title = null, slide_text = null, extra_html = null) {
  if (!createdMaps.includes(layer)) return md``;
  var mappingLayers = [...(extra_layers ?? []), layer]
    .map(lay => layerParams[lay].group_id)
    .filter(Boolean)
    .join(";"); 
  // To avoid rendering "null", "undefined", or "" in the document, return nothing explicitly:
  // if (!createdMaps.includes(layer)) return;
  if (!slide_text && layer) slide_text = slide_texts[layer];
  if (!title) title = slide_text?.title;
  if (!title && layer) title = layer;
  return html`
    <section class="level3" id="${layer}">
      ${md`### ${title}`}
      ${html`<div class="map-list" data-layers="${mappingLayers}"></div>`}
      ${chart ?? ""}
      ${addSlideText(slide_text)}
      ${extra_html ?? ""}
    </section>
  `
}

textColumn = d3.select('.text-column').node();
columnWidth = textColumn.getBoundingClientRect().width * .9;

plotsReady = {
  setD3(d3);
  setWidth(typeof columnWidth !== 'undefined' ? columnWidth : width * 0.45);
  setHeightRatio(0.9);
  setCity(city);
  setCountry(country);
  return true;
}

d = plotsReady ? await loadData : null
```

:::

::: topbar
# {{< meta title >}}

::: navigation
```{r}
#| label: navigation
#| output: asis
# Dynamically add sections to table of contents ... there's probably a better way?
sections <- readLines("index.qmd") %>%
  str_subset("^## ") %>%
  str_replace("## ", "")
# Slugify section names to make anchor paths
anchors <- sections %>%
  tolower() %>%
  str_replace_all(c("[^a-z\\s]" = "", "\\s+" = "-")) %>%
  { paste0("#", .) }
cat(sep = "\n",
  "1. <span id='dynamic-header'>City Scan</span>  &or;",
  paste0("    ", seq_along(sections), ". [", sections, "]", "(", anchors, ")"))
```
:::

<div>
by the [City Resilience Program](https://www.gfdrr.org/en/crp)
</div>

:::

::: {#cover-page}
# {{< meta title >}} <!-- Put "City Scan" on second line-->

City Scan

`r month.name[lubridate::month(Sys.Date())]` `r lubridate::year(Sys.Date())`

::: donors
![GFDRR](source/donors/CRP_GFDRR_Logo.png)

![World Bank](source/donors/WB%20Logo.png)

![Austrian Federal Ministry of Finance](source/donors/Austria%20BMF%20Logo.png)

![Swiss Confederation Federal Department of Economic Affairs State Secretariat for Economic Affairs SECO](source/donors/SECO%20Logo.png)

![Gates Foundation](source/donors/Gates%20Foundation%20Logo%20-%20Horizontal.png)

![MAECI](source/donors/MAECI-logo-horizontal.png)

![AICS](source/donors/AICS%20Logo.png)
:::

:::

<!-- Hiding cover map until we have a way of producing it on Google Cloud -->
<!-- While hiding, also raising the map* -->
<!-- <div id="cover-map">
![](`r cover_image`)
</div> -->

::: text-column

## Executive Summary
```{r}
#| output: asis
#| label: executive_summary
slide_texts$executive_summary_no_anchor_ids$takeaways <-
  # If not adding 'Go to section' link, only need these 2 lines + print_slide_text()
# unlist(slide_texts$executive_summary) %>%
#   str_replace_all("#### (.*$)", "<p class='pseudo-h4'>\\1</p>")
  unlist(slide_texts$executive_summary) %>% paste(collapse="\n") %>%
  str_split("#### ") %>% .[[1]] %>% str_subset("^$", negate = T) %>%
  (\(x) modify_at(x, length(x), ~ paste0(.x, "\n\n")))() %>%
  lapply(\(x) {
    section <- str_extract(x, "^.*")
    x <- str_replace(x, "^(.*)",  "<p class='pseudo-h4'>\\1</p>")
    anchor <- str_replace_all(tolower(trimws(section)), c("[^a-z\\s]" = "", "\\s+" = "-")) %>%
      { paste0("#", .) }
    glue("{x}\n<p>â†’ [Go to section]({anchor})</p>\n")
  }) %>%
  str_split("\n\n") %>% unlist()
print_slide_text(slide_texts$executive_summary_no_anchor_ids)
```

## Setting the Context

### Basic City Information
```{r}
#| output: asis
#| label: basic_city_info
print_slide_text(slide_texts$basic_city_info)
```

## Population and Demographic Trends

```{ojs}
//| output: true
fillSlide("population", null, null, null, null,

html`<section class="level4">
    ${md`#### Population Growth`}
    ${plot_pga(d.pg) ?? ""}
    ${addSlideText(slide_texts.population_growth)}
    </section>`
)
```


```{r}
#| output: asis
plots_file <- fuzzy_read(charts_dir, "oxford-pop-density-scatter", paste)
if (!is.na(plots_file)) {
  cat("#### Population Density\n") 
  cat(glue('<img style="max-width:95%" src="{plots_file}">\n\n\n'))
  print_slide_text(slide_texts$population_density_chart)
}
```

```{r}
#| output: true
plots_file <- fuzzy_read(charts_dir, "oxford-age-structure-area", paste)
# THIS STAYS GREYED OUT
if (!is.na(plots_file)) {
  cat("#### Population Distribution by Age\n") 
  cat(glue('<img style="max-width:95%" src="{plots_file}">\n\n\n'))
  print_slide_text(slide_texts$population_density_chart)
}
```

```{ojs}
//| output: asis
// html`<section class="level4">
//     ${md`#### Population Distribution by Age & Sex`}
//     ${plot_age(d.pas) ?? ""}
//     ${plot_pas_pyramid(d.pas) ?? ""}
//     ${addSlideText(slide_texts.population_distribution_age_sex)}
//     </section>`

// import {chart_rwi_area} 
// with {columnWidth as plotWidth}
// from "@carolinecullinan/nouakchott-scanned"

// fillSlide("rwi", chart_rwi_area)
fillSlide("rwi", plot_rwi_area(d.rwi_area))
```

## Economic Activity

```{ojs}
//| output: true
fillSlide("economic_activity")
fillSlide("economic_change")
```

## Built Form

```{ojs}
//| output: true
fillSlide("wsf", [plot_uba_area(d.uba_area), plot_ubaa(d.uba)])

fillSlide("wsf_tracker")

fillSlide("land_cover", plot_lc(d.lc))
fillSlide("school_zones", null, null, null, slide_texts.school_proximity)
fillSlide("health_zones", null, null, null, slide_texts.health_proximity)
```

## Climate Conditions

```{ojs}
//| output: true
// import {chart_pv_alt}
// with {columnWidth as plotWidth}
// from "@carolinecullinan/nouakchott-scanned"

// fillSlide("solar", plot_pv_area(d.pv_area))
fillSlide("solar", [plot_pv_alt(d.pv), plot_pv_area(d.pv_area)], null, null, null)
// plot_pv_d(d.pv)
// plot_pv(d.pv)

fillSlide("air_quality", plot_aq(d.aq_area))
fillSlide("summer_lst", plot_summer_area(d.summer_area))
fillSlide("vegetation", plot_ndvi_area(d.ndvi_area))
fillSlide("forest", null, ["deforest"])
```

## Risk Identification

```{ojs}
//| output: true
html`<section class="level4 is-active">
    ${md`#### Signficant Flood Events`}
    ${plot_fe(d.fe) ?? ""}
    ${addSlideText(slide_texts.flood_events)}
    </section>`

fillSlide("fluvial", null, ["infrastructure"], null, slide_texts.flooding_infrastructure_fluvial)
fillSlide("pluvial", null, ["infrastructure"], null, slide_texts.flooding_infrastructure_pluvial)
fillSlide("coastal", null, ["infrastructure"], null, slide_texts.flooding_infrastructure_coastal)
fillSlide("combined_flooding", null, ["infrastructure"], null, slide_texts.flooding_infrastructure_combined)

fillSlide("fluvial", plot_fu(d.fu), ["wsf"], null, slide_texts.flooding_builtup_fluvial)
fillSlide("pluvial", plot_pu(d.pu), ["wsf"], null, slide_texts.flooding_builtup_pluvial)
fillSlide("coastal", plot_cu(d.cu), ["wsf"], null, slide_texts.flooding_builtup_coastal)
fillSlide("combined_flooding", plot_comb(d.comb, d.pu, d.fu, d.cu), ["wsf"], null, slide_texts.flooding_builtup_combined)

fillSlide("fluvial", null, ["population"], null, slide_texts.flooding_population_fluvial)
fillSlide("pluvial", null, ["population"], null, slide_texts.flooding_population_pluvial)
fillSlide("coastal", null, ["population"], null, slide_texts.flooding_population_coastal)
fillSlide("combined_flooding", null, ["population"], null, slide_texts.flooding_population_combined)

fillSlide("elevation", plot_e(d.e))
fillSlide("slope", plot_s(d.s))
fillSlide("landslides", plot_ls_area(d.ls_area))
```

```{r}
#| output: asis
plots_file <- fuzzy_read(file.path(output_dir, "plots/html"), "earthquake_timeline", paste)
if (!is.na(plots_file)) {
  cat("### Significant earthquakes\n") 
  include_html_chart(plots_file)
}
```

<!-- html`<section class="level4">
    ${md`#### Signficant Earthquake Events`}
    ${chart_ee ?? ""}
    ${addSlideText(slide_texts.earthquake_events)}
    </section>` -->

```{r}
#| output: asis
# fill_slide_content("liquefaction")
```

```{ojs}
//| output: true

fillSlide("liquefaction", plot_l_area(d.l_area))
fillSlide("roads")
fillSlide("burnable", plot_fwi(d.fwi))
// plot_fwi_d(d.fwi)
fillSlide("moisture")

fillSlide("burnt_area")
```

## Local Institutions & Planning

### Administrative Structure

```{r}
#| output: asis
print_slide_text(slide_texts$administrative_structure)
```

### Availability Of Development Plans And Policies

```{r}
#| output: asis
print_slide_text(slide_texts$document_availability)
```

### The State of Urban Infrastructure and Service Delivery

```{r}
#| output: asis
print_slide_text(slide_texts$infrastructure_and_service_delivery)
```


## Key Considerations for Investment Planning & Prioritization

### Concluding Questions

```{r}
#| output: asis
print_md(slide_texts$concluding_questions)
```

:::

::: maps
```{r}
#| output: true
#| label: leaflet_maps
# # all_maps # Created in maps.R
aoi_fgb <- file.path(fgb_dir, "aoi.fgb")

plots_html %>%
  { Reduce(\(x, f) f(x), ., init = plot_basemap("vector")) } %>%
  addFgb(file = aoi_fgb, stroke = TRUE, color = "black", weight = 2, fill = F, opacity = .9) %>%
  addLayersControl(
    overlayGroups = group_ids,
    position = "topleft",
    options = layersControlOptions(collapsed = TRUE)) %>%
  addScaleBar(position = "bottomleft")

# If I want to use javascript directly I could use htmlwidgets::onRender(),
# or maybe just an observable cell
```

:::

::: foot
Last edited `r Sys.Date()`.

This City Scan is a product of the City Resilience Program.

The findings, interpretations, and conclusions expressed in this City Scan do not necessarily reflect the views of the World Bank, the Executive Directors of the World Bank, or the governments they represent. Given that the data included in this work are derived from global sources, the World Bank does not guarantee its accuracy.

:::

{{< include source/scrollytelling.qmd >}}

```{ojs}
//| output: false
loadData = {
  var [pg, pas, rwi_area, uba, uba_area, lc, pug, pv, pv_area,
         aq_area, summer_area, ndvi_area, fu, pu, cu, comb,
         e, s, ls_area, l_area, fwi] = await Promise.all([
    FileAttachment("./02-process-output/tabular/processed/pg.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/pas.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/rwi_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/uba.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/uba_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/lc.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/pug.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/pv.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/pv_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/aq_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/summer_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/ndvi_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/fu.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/pu.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/cu.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/comb.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/e.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/s.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/ls_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/l_area.csv").csv({typed: true}),
    FileAttachment("./02-process-output/tabular/processed/fwi.csv").csv({typed: true})
  ]);

  var fe = [{begin_year: 1995, begin_month: 9, DISPLACED: 95000, severity: "Large event", line1: "SEPTEMBER 1995", line2: "95,000 displaced", line3: ""}];

  return {pg, pas, rwi_area, uba, uba_area, lc, pug, pv, pv_area, aq_area, summer_area, ndvi_area, fu, pu, cu, comb, e, s, ls_area, l_area, fwi, fe};
}
```
